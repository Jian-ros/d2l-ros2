4.9 Python服务通信实现(李四借钱)

大家好，我是小鱼。上节说完如何自定义ROS2的服务接口。

相信你已经迫不及待的想尝试一下编写代码了，让我们一起动起手,让李三成功借钱，吃上麻辣烫吧。

1.如何编写一个Python服务

开始之前，我们先说一下创建ROS2服务端和客户端的基本步骤。

首先是服务端：

- 创建与导入服务接口
- 创建服务端并定义服务端回调函数
- 编写回调函数处理数据并返回结果

客户端

- 导入服务接口
- 创建客户端及客户端服务结果接收回调函数
- 在回调函数中处理服务端返回结果



2.编写服务端李四代码

我们先来创建李四这边的服务端。用VsCode打开我们的`town_ws`工作区。

2.1 导入服务接口

我们在上一节中自定义的服务接口这里该怎么使用呢？

需要下面两个步骤：

2.1.1 添加依赖

导入依赖是为了能够让我们的代码找到对应的接口。

因为`village_li`是包类型是`ament_python`这里只需要在`package.xml`中加入下面的代码即可：

```
  <depend>village_interfaces</depend>
```

![image-20210816153438400](4.9服务实现(Python)/imgs/image-20210816153438400.png)

2.1.2 程序中导入

程序中导入也是只需要一行代码即可完成，打开li4.py,在首部加入下面一行代码。

```
#从村庄接口服务类中导入借钱服务
from village_interfaces.srv import BorrowMoney
```

2.2 创建服务端并定义服务回调函数

2.2.1创建服务端

接着创建一个服务，继承于`Node`之后，`Li4Node`也具备了创建一个服务的能力。在`Li4Node`的`init`函数中创建成员变量`borrow_server`。

```
# 新建借钱服务
self.borrow_server = self.create_service(BorrowMoney, "borrow_money", self.borrow_money_callback)
```

需要传入三个参数：

- 服务接口类型，`BorrowMoney`，我们在2.1.2导入的

- 服务名称，`"borrow_money"`，具有唯一性，自己手打的

- 回调函数，`self.borrow_money_callback`，我们下一步定义的。

  > 回调函数的意思是，正常情况下不会调用的函数，当接收到客户端发送请求的时候，服务端就会自动调用回调函数并将请求数据和返回数据作为该函数的参数传递给该回调函数。

2.2.2 定义回调函数

```python
def borrow_money_callback(self,request, response):
    """
    借钱回调函数
    参数：request 客户端请求对象，携带者来自客户端的数据
         response： 服务端响应，返回服务端的处理结果
    返回值：response
    """
    return response
```

这个函数有三个入口参数,self代表本身，这个没啥好说的，类似于c++和java里的this。

- request 是客户端请求对象，携带者来自客户端的数据。

  其结构就是上一节中我们所定义的`name`和`money`组成

- response 是服务端响应，返回服务端的处理结果

  其结构由`success`和`money`组成

2.3编写回调函数

接下来开始正式编写回调函数，回调函数的输入是request和response，输出是我们处理后的reponse(当然也可以不处理，使用默认值)

```python
def borrow_money_callback(self,request, response):
    """
    借钱回调函数
    参数：request 客户端请求
            response： 服务端响应
    返回值：response
    """
    self.get_logger().info("收到来自: %s 的借钱请求，目前账户内还有%d元" % (request.name, self.account))
    #根据李四借钱规则，借出去的钱不能多于自己所有钱的十分之一，不然就不借
    if request.money <= int(self.account*0.1):
        response.success = True
        response.money = request.money
        self.account = self.account - request.money
        self.get_logger().info("借钱成功，借出%d 元 ,目前账户余额%d 元" % (response.money,self.account))
    else:
        response.success = False
        response.money = 0
        self.get_logger().info("对不起兄弟，手头紧,不能借给你")
    return response
```

这里代码其实并不复杂，先判断要借钱的金额是否满足要借出去的数量，如果满足则借，不然就不借。

3.测试服务端代码

3.1编译运行

3.2查看服务列表

3.3手动调用

4.编写客户端代码

4.1导入服务接口

4.2创建客户端并定义完成时回调函数

4.3编写回调函数，处理返回结果

5.整体测试

```
ros2 service call /borrow_money village_interfaces/srv/BorrowMoney  "{name: {data: '123'}, money:{data:123}}"
```







